

<main class="main-booking" *ngIf="user">
  <div class="booking-container" *ngIf="user.role === 'PATIENT'">
    
    <!-- LEFT SIDEBAR -->
    <aside class="appointment-sidebar">
      
      <!-- Upcoming Section -->
      <section class="appointment-section" *ngIf="upcomingApps.length > 0">
        <h3 class="section-title">Rendez-vous à venir</h3>
        <div 
          class="appointment-card upcoming" 
          *ngFor="let app of upcomingApps"
          [class.active]="selectedAppointment === app"
          (click)="selectAppointment(app)">
          
          <div class="card-header-strip">
            <span><i class="far fa-calendar"></i> {{ app.dateRv | date:'EEEE d MMMM' }}</span> 
            <span><i class="far fa-clock"></i> {{ app.heureRv }}</span>
          </div>
          
          <div class="card-body">
            <div class="doctor-info-mini">
              <img [src]="app.dentistPhoto || defaultAvatar" class="avatar-mini" alt="Dr">
              <div class="text-info">
                <div class="doc-name">{{ app.dentistName || 'Dr Inconnu' }}</div>
                <div class="doc-spec">{{ app.dentistSpeciality || 'Dentiste' }}</div>
              </div>
            </div>
            <div class="service-name">
              <i class="fas fa-tooth"></i> {{ app.serviceName }}
            </div>
          </div>
        </div>
      </section>

      <!-- Past Section -->
      <div class="past-section-wrapper" *ngIf="pastApps.length > 0">
        
        <!-- Toggle Link (Centered) -->
        <div *ngIf="!showPastAppointments" class="toggle-past-link" (click)="showPastAppointments = true">
          Voir mes rendez-vous passés
        </div>

        <!-- Expanded Content -->
        <section class="appointment-section" *ngIf="showPastAppointments">
          <h3 class="section-title">Rendez-vous passés</h3>
          <div 
            class="appointment-card past" 
            *ngFor="let app of pastApps"
            [class.active]="selectedAppointment === app"
            (click)="selectAppointment(app)">
            
            <div class="card-date-header">
              <span><i class="far fa-calendar-alt"></i> {{ app.dateRv | date:'EEEE d MMM yyyy' }}</span>
              <span><i class="far fa-clock"></i> {{ app.heureRv }}</span>
            </div>

            <div class="card-body">
              <div class="doctor-info-mini">
                <img [src]="app.dentistPhoto || defaultAvatar" class="avatar-mini" alt="Dr">
                <div class="text-info">
                  <div class="doc-name">{{ app.dentistName || 'Dr Inconnu' }}</div>
                  <div class="doc-spec">{{ app.dentistSpeciality || 'Dentiste' }}</div>
                </div>
              </div>
              <div class="service-name">
                <i class="fas fa-tooth"></i> {{ app.serviceName }}
              </div>
            </div>
          </div>
        </section>
      </div>

      <div *ngIf="appointments.length === 0" class="no-appointments">
        Aucun rendez-vous trouvé.
      </div>
    </aside>

    <!-- RIGHT DETAILS PANEL -->
    <section class="details-panel" *ngIf="selectedAppointment">
      <h2 class="panel-title">Informations du rendez-vous</h2>
      
      <div class="detail-card main-detail">
        <div class="blue-header">
          <span><i class="far fa-calendar-alt"></i> {{ selectedAppointment.dateRv | date:'EEEE d MMM yyyy' }}</span>
          <span><i class="far fa-clock"></i> {{ selectedAppointment.heureRv }}</span>
        </div>
        
        <div class="detail-body">
          <div class="doctor-main-info">
            <img [src]="selectedAppointment.dentistPhoto || defaultAvatar" class="avatar-large">
            <div class="info-block">
              <h3>{{ selectedAppointment.dentistName || 'Dr Inconnu' }}</h3>
              <p class="speciality">{{ selectedAppointment.dentistSpeciality || 'Dentiste' }}</p>
            </div>
          </div>
          
          <div class="consultation-line">
            <i class="fas fa-tooth"></i> {{ selectedAppointment.serviceName }}
          </div>
          
          <div class="action-buttons-row" *ngIf="isUpcoming(selectedAppointment.dateRv)">
            <button class="btn-action outline" (click)="rescheduleBooking(selectedAppointment)">
              <i class="fas fa-history"></i> Déplacer le RDV
            </button>
            <button class="btn-action danger" (click)="cancelBooking(selectedAppointment.idRv!)">
              <i class="far fa-calendar-times"></i> Annuler le RDV
            </button>
          </div>
        </div>
      </div>

      <div class="action-list-links">
        <div class="link-item">
          <span><i class="fas fa-sync-alt"></i> Réserver de nouveau</span>
          <i class="fas fa-chevron-right arrow"></i>
        </div>
        <div class="link-item" (click)="goToDentistProfile(selectedAppointment.dentistId || 0)">
          <span><i class="fas fa-id-card-alt"></i> Retourner sur la fiche de {{ selectedAppointment.dentistName }}</span>
          <i class="fas fa-chevron-right arrow"></i>
        </div>
      </div>

    </section>

    <!-- Empty State (Selection) -->
    <div class="details-panel empty" *ngIf="!selectedAppointment && upcomingApps.length > 0">
      <p>Sélectionnez un rendez-vous pour voir les détails.</p>
    </div>

    <!-- Empty State (No Interviews) -->
    <div class="details-panel no-appointments-state" *ngIf="upcomingApps.length === 0 && !selectedAppointment">
      <div class="empty-content">
        <div class="calendar-icon-stack">
           <i class="fas fa-calendar-alt base"></i>
           <i class="fas fa-calendar-check overlay"></i>
        </div>
        <h3>Aucun rendez-vous à venir</h3>
        <p>Prenez votre santé en main. Réservez facilement votre prochain rendez-vous sur Dentis.</p>
        <button class="btn-primary-large" (click)="goToHome()">PRENDRE RENDEZ-VOUS</button>
      </div>
    </div>

  </div>

  <!-- Fallback for Dentist View (Original Content for Dentist) -->
    <ng-container *ngIf="user.role === 'DENTISTE'">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Demandes</h3>
                <div class="search-box-small">
                    <input type="text" placeholder="Rechercher..." [(ngModel)]="appointmentSearch">
                </div>
            </div>

            <div *ngIf="filteredAppointments.length === 0" class="empty-list">Aucune demande.</div>
            
            <div class="rv-list">
                <div class="rv-card" *ngFor="let rv of filteredAppointments">
                    <div class="rv-header">
                        <span class="rv-date">{{ rv.dateRv | date:'shortDate' }}</span>
                        <span class="rv-time">{{ rv.heureRv }}</span>
                    </div>
                    <div class="rv-body">
                        <p class="rv-patient">{{ rv.patientName }}</p>
                        <span class="status-badge" [class]="rv.statutRv">{{ rv.statutRv }}</span>
                    </div>
                    <div class="rv-actions" *ngIf="rv.statutRv === 'PENDING'">
                        <button class="btn-accept" (click)="validateRendezvous(rv.idRv!, 'VALIDATED')">✔</button>
                        <button class="btn-reject" (click)="validateRendezvous(rv.idRv!, 'REFUSED')">✘</button>
                    </div>
                </div>
            </div>
        </aside>
    
        <div class="content-area">
            <div class="header-split">
                <h2>Mes Services</h2>
                <div class="controls-row">
                    <div class="search-box">
                        <input type="text" placeholder="Rechercher un service..." [(ngModel)]="serviceSearch">
                    </div>
                    <button class="btn-primary" (click)="toggleCreateService()">
                        {{ showCreateServiceModule ? 'Fermer' : 'Nouveau Service' }}
                    </button>
                </div>
            </div>

            <div *ngIf="showCreateServiceModule" class="service-form">
                <input placeholder="Nom" [(ngModel)]="newService.nomSM">
                <input placeholder="Type" [(ngModel)]="newService.typeSM">
                <input placeholder="Description" [(ngModel)]="newService.descriptionSM">
                <input type="number" placeholder="Tarif" [(ngModel)]="newService.tarifSM">
                <p>Upload image (Base64) - Not implemented in UI</p> 
                <button (click)="submitNewService()">Créer</button>
            </div>
            
            <div class="services-grid">
                <div class="service-card" *ngFor="let s of filteredServices">
                    <div class="card-img" [style.background-image]="'url(' + (s.image || 'assets/images/placeholder.png') + ')'"></div>
                    <div class="card-content">
                        <h3>{{ s.nomSM }}</h3>
                        <p class="service-price">{{ s.tarifSM }} TND</p>
                        <p class="service-desc" *ngIf="s.descriptionSM">{{ s.descriptionSM }}</p>
                        <button class="btn-delete" (click)="deleteService(s.numSM!)">Supprimer</button>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

  <!-- Confirm Cancel Modal -->
  <div class="modal-overlay" *ngIf="showCancelModal">
    <div class="modal-box">
      <button class="close-btn" (click)="closeCancelModal()">
        <i class="fas fa-times"></i>
      </button>

      <div class="illustration-container">
        <div class="calendar-circle">
          <i class="fas fa-calendar-check"></i>
          <div class="mini-squares">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>

      <h3 class="modal-title">Êtes-vous sûr de vouloir annuler votre rendez-vous ?</h3>

      <div class="modal-actions">
        <button class="btn-keep" (click)="closeCancelModal()">CONSERVER LE RENDEZ-VOUS</button>
        <button class="btn-continue" (click)="confirmCancel()">ANNULER</button>
      </div>
    </div>
  </div>
</main>
