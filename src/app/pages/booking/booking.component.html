

<main class="main-booking" *ngIf="user">
  <div class="booking-container" *ngIf="user.role === 'PATIENT'">
    
    <!-- LEFT SIDEBAR -->
    <aside class="appointment-sidebar">
      
      <!-- Upcoming Section -->
      <section class="appointment-section" *ngIf="upcomingApps.length > 0">
        <h3 class="section-title">Rendez-vous à venir</h3>
        <div 
          class="appointment-card upcoming" 
          *ngFor="let app of upcomingApps"
          [class.active]="selectedAppointment === app"
          (click)="selectAppointment(app)">
          
          <div class="card-header-strip">
            <span><i class="far fa-calendar"></i> {{ app.dateRv | date:'EEEE d MMMM' }}</span> 
            <span><i class="far fa-clock"></i> {{ app.heureRv }}</span>
          </div>
          
          <div class="card-body">
            <div class="doctor-info-mini">
              <img [src]="app.dentistPhoto || defaultAvatar" class="avatar-mini" alt="Dr">
              <div class="text-info">
                <div class="doc-name">{{ app.dentistName || 'Dr Inconnu' }}</div>
                <div class="doc-spec">{{ app.dentistSpeciality || 'Dentiste' }}</div>
              </div>
            </div>
            <div class="service-name">
              <i class="fas fa-tooth"></i> {{ app.serviceName }}
            </div>
          </div>
        </div>
      </section>

      <!-- Past Section -->
      <div class="past-section-wrapper" *ngIf="pastApps.length > 0">
        
        <!-- Toggle Link (Centered) -->
        <div *ngIf="!showPastAppointments" class="toggle-past-link" (click)="showPastAppointments = true">
          Voir mes rendez-vous passés
        </div>

        <!-- Expanded Content -->
        <section class="appointment-section" *ngIf="showPastAppointments">
          <h3 class="section-title">Rendez-vous passés</h3>
          <div 
            class="appointment-card past" 
            *ngFor="let app of pastApps"
            [class.active]="selectedAppointment === app"
            (click)="selectAppointment(app)">
            
            <div class="card-date-header">
              <span><i class="far fa-calendar-alt"></i> {{ app.dateRv | date:'EEEE d MMM yyyy' }}</span>
              <span><i class="far fa-clock"></i> {{ app.heureRv }}</span>
            </div>

            <div class="card-body">
              <div class="doctor-info-mini">
                <img [src]="app.dentistPhoto || defaultAvatar" class="avatar-mini" alt="Dr">
                <div class="text-info">
                  <div class="doc-name">{{ app.dentistName || 'Dr Inconnu' }}</div>
                  <div class="doc-spec">{{ app.dentistSpeciality || 'Dentiste' }}</div>
                </div>
              </div>
              <div class="service-name">
                <i class="fas fa-tooth"></i> {{ app.serviceName }}
              </div>
            </div>
          </div>
        </section>
      </div>

      <div *ngIf="appointments.length === 0" class="no-appointments">
        Aucun rendez-vous trouvé.
      </div>
    </aside>

    <!-- RIGHT DETAILS PANEL -->
    <section class="details-panel" *ngIf="selectedAppointment">
      <h2 class="panel-title">Informations du rendez-vous</h2>
      
      <div class="detail-card main-detail">
        <div class="blue-header">
          <span><i class="far fa-calendar-alt"></i> {{ selectedAppointment.dateRv | date:'EEEE d MMM yyyy' }}</span>
          <span><i class="far fa-clock"></i> {{ selectedAppointment.heureRv }}</span>
        </div>
        
        <div class="detail-body">
          <div class="doctor-main-info">
            <img [src]="selectedAppointment.dentistPhoto || defaultAvatar" class="avatar-large">
            <div class="info-block">
              <h3>{{ selectedAppointment.dentistName || 'Dr Inconnu' }}</h3>
              <p class="speciality">{{ selectedAppointment.dentistSpeciality || 'Dentiste' }}</p>
            </div>
          </div>
          
          <div class="consultation-line">
            <i class="fas fa-tooth"></i> {{ selectedAppointment.serviceName }}
          </div>
          
          <div class="action-buttons-row" *ngIf="isUpcoming(selectedAppointment.dateRv)">
            <button class="btn-action outline" (click)="rescheduleBooking(selectedAppointment)">
              <i class="fas fa-history"></i> Déplacer le RDV
            </button>
            <button class="btn-action danger" (click)="cancelBooking(selectedAppointment.idRv!)">
              <i class="far fa-calendar-times"></i> Annuler le RDV
            </button>
          </div>
        </div>
      </div>

      <div class="action-list-links">
        <div class="link-item">
          <span><i class="fas fa-sync-alt"></i> Réserver de nouveau</span>
          <i class="fas fa-chevron-right arrow"></i>
        </div>
        <div class="link-item" (click)="goToDentistProfile(selectedAppointment.dentistId || 0)">
          <span><i class="fas fa-id-card-alt"></i> Retourner sur la fiche de {{ selectedAppointment.dentistName }}</span>
          <i class="fas fa-chevron-right arrow"></i>
        </div>
      </div>

    </section>

    <!-- Empty State (Selection) -->
    <div class="details-panel empty" *ngIf="!selectedAppointment && upcomingApps.length > 0">
      <p>Sélectionnez un rendez-vous pour voir les détails.</p>
    </div>

    <!-- Empty State (No Interviews) -->
    <div class="details-panel no-appointments-state" *ngIf="upcomingApps.length === 0 && !selectedAppointment">
      <div class="empty-content">
        <div class="calendar-icon-stack">
           <i class="fas fa-calendar-alt base"></i>
           <i class="fas fa-calendar-check overlay"></i>
        </div>
        <h3>Aucun rendez-vous à venir</h3>
        <p>Prenez votre santé en main. Réservez facilement votre prochain rendez-vous sur Dentis.</p>
        <button class="btn-primary-large" (click)="goToHome()">PRENDRE RENDEZ-VOUS</button>
      </div>
    </div>

  </div>

  <!-- Fallback for Dentist View (Original Content for Dentist) -->
    <div class="booking-container dentist-view" *ngIf="user.role === 'DENTISTE'">
        
        <!-- HEADER TOOLBAR -->
        <div class="calendar-toolbar">
            <div class="toolbar-left">
                <div class="nav-arrows">
                    <button class="btn-icon" (click)="prevWeek()"><i class="fas fa-chevron-left"></i></button>
                    <button class="btn-icon" (click)="nextWeek()"><i class="fas fa-chevron-right"></i></button>
                </div>
                <!-- Calculate range label -->
                 <span class="date-range-label" *ngIf="weekDays.length > 0">
                     {{ weekDays[0] | date:'d' }} - {{ weekDays[weekDays.length-1] | date:'d MMMM yyyy' }}
                 </span>
            </div>
            
            <div class="toolbar-right">
            </div>
        </div>

        <div class="calendar-layout">
            <!-- LEFT SIDEBAR -->
            <aside class="calendar-sidebar">
                
                <!-- Mini Calendar Placeholder -->
                <div class="mini-calendar">
                    <div class="mini-cal-header">
                        <i class="fas fa-chevron-left" (click)="prevMonth()"></i>
                        <span>{{ currentWeekStart | date:'MMMM yyyy' }}</span>
                        <i class="fas fa-chevron-right" (click)="nextMonth()"></i>
                    </div>
                    <div class="mini-cal-grid">
                        <!-- Standard 7x5 grid mock -->
                        <div class="row header"><span>Lu</span><span>Ma</span><span>Me</span><span>Je</span><span>Ve</span><span>Sa</span><span>Di</span></div>
                        
                         <div class="row" *ngFor="let row of miniCalRows">
                             <span *ngFor="let d of row" 
                                   (click)="goToWeek(d)"
                                   [class.active-week]="isInCurrentWeek(d)"
                                   [style.opacity]="isCurrentMonth(d) ? 1 : 0.4">
                                   {{ d | date:'d' }}
                             </span>
                         </div>
                    </div>
                </div>

                <!-- Selected Appointment Detail Card -->
                <div class="side-detail-card red-theme" *ngIf="selectedCalendarEvent; else noEventSelected" [style.border-left-color]="selectedCalendarEvent.color">
                    <div class="card-title">{{ selectedCalendarEvent.serviceName || 'Consultation' }}</div>
                    <div class="card-info-row" style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <div class="card-date">{{ selectedCalendarEvent.start | date:'EEEE d MMMM' }}</div>
                            <div class="card-time">{{ selectedCalendarEvent.start | date:'HH:mm' }} → {{ getEndTime(selectedCalendarEvent) }}</div>
                        </div>
                        <div class="card-price" *ngIf="selectedCalendarEvent.totalPrice">
                            {{ selectedCalendarEvent.totalPrice }} <span style="font-size: 0.8em; font-weight: normal;">TND</span>
                        </div>
                    </div>
                </div>
                <ng-template #noEventSelected>
                     <div class="side-detail-card" style="background:#f9f9f9; color:#999; border-left: 4px solid #ddd;">
                        <div class="card-title">Sélectionnez un RDV</div>
                        <div class="card-date">pour voir les détails</div>
                    </div>
                </ng-template>
                
                <div class="side-patient-info" *ngIf="selectedCalendarEvent">
                    <div class="p-header">
                        <i class="fas" 
                           *ngIf="selectedCalendarEvent.patient !== '(Sans patient)'"
                           [class.fa-venus]="selectedCalendarEvent.gender === 'F'" 
                           [class.fa-mars]="selectedCalendarEvent.gender !== 'F'"
                           [style.color]="selectedCalendarEvent.gender === 'F' ? '#E91E63' : '#4A90E2'"></i>
                        <span [style.margin-left]="selectedCalendarEvent.patient !== '(Sans patient)' ? '5px' : '0'"><strong>{{ selectedCalendarEvent.patient }}</strong></span>
                        <span class="badge-new" *ngIf="selectedCalendarEvent.isNew">Nouveau</span>
                    </div>
                    <div class="p-details">
                        <p>{{ selectedCalendarEvent.phone }}</p>
                        <p>{{ selectedCalendarEvent.birthDate | date:'dd/MM/yyyy' }} {{ getAge(selectedCalendarEvent.birthDate) }}</p>
                        <div class="small-meta" style="margin-top:5px; padding-top:5px; border-top:1px dashed #eee; font-size:12px; color:#888;">
                           Groupe: <strong style="color:#333;">{{ selectedCalendarEvent.bloodGroup }}</strong> <br>
                           Recouvrement: <span style="background:#eef; padding:1px 4px; border-radius:3px; color:#446;">{{ selectedCalendarEvent.coverageType }}</span>
                        </div>
                        
                        <button class="btn-reject" (click)="rejectAppointment(selectedCalendarEvent)">
                            <i class="fas fa-ban" style="margin-right: 5px;"></i> Rejeter le RDV
                        </button>
                    </div>
                </div>

            </aside>
        
            <!-- MAIN CALENDAR GRID -->
            <div class="calendar-wrapper">
                
                <!-- Day Header Row -->
                <div class="cal-header-row">
                    <div class="time-gutter-header"></div>
                    <div class="day-header" *ngFor="let day of weekDays">
                        <div class="day-name">{{ day | date:'EEE.' }} {{ day | date:'d' }}</div>
                        <div class="day-options" (click)="openAddAppointmentModal(day)">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <!-- Scrollable Body -->
                <div class="cal-body">
                    <!-- Time Gutter -->
                    <div class="time-gutter">
                        <div class="time-slot" *ngFor="let h of hours">
                            <span>{{ h }}</span>
                        </div>
                    </div>

                    <!-- Day Columns -->
                    <div class="day-column" *ngFor="let day of weekDays">
                        <!-- Grid Lines -->
                        <div class="grid-line" *ngFor="let h of hours"></div>

                        <!-- Events -->
                         <ng-container *ngFor="let event of getEventsForDaySimple(day)">
                             <div class="cal-event" 
                                  (click)="selectCalendarEvent(event)"
                                  (contextmenu)="onRightClickEvent($event, event)"
                                  [style.top.px]="getEventTop(event)"
                                  [style.height.px]="getEventHeight(event)"
                                  [style.background-color]="event.color"
                                  [class.selected]="selectedCalendarEvent === event"
                                  [class.has-duration]="true">
                                  
                                  <div class="event-time">{{ event.start | date:'H:mm' }}</div>
                                  <div class="event-title"><strong>{{ event.patient }}</strong></div>
                                  <div class="event-desc" *ngIf="event.id === 20">Adresse</div><!-- Mock for Formation -->
                                  
                                  <div class="event-status-icon" *ngIf="selectedCalendarEvent === event">
                                      <i class="fas fa-user"></i>
                                  </div>
                             </div>
                         </ng-container>
                         
                         <!-- Demo "Current Time" Line (only on 'today') -->
                         <!-- <div class="current-time-line" style="top: 450px;"></div> -->
                    </div>
                </div>
            </div>
        </div>
    
    </div>

  <!-- Confirm Cancel Modal -->
  <div class="modal-overlay" *ngIf="showCancelModal">
    <div class="modal-box">
      <button class="close-btn" (click)="closeCancelModal()">
        <i class="fas fa-times"></i>
      </button>

      <div class="illustration-container">
        <div class="calendar-circle">
          <i class="fas fa-calendar-check"></i>
          <div class="mini-squares">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>

      <h3 class="modal-title">Êtes-vous sûr de vouloir annuler votre rendez-vous ?</h3>

      <div class="modal-actions">
        <button class="btn-keep" (click)="closeCancelModal()">CONSERVER LE RENDEZ-VOUS</button>
        <button class="btn-continue" (click)="confirmCancel()">ANNULER</button>
      </div>
    </div>
  </div>

  <!-- Add Appointment Modal -->
  <div class="modal-overlay" *ngIf="showAddAppointmentModal">
    <div class="modal-box appointment-modal">
        <div class="modal-header">
            <h3>Nouveau Rendez-vous</h3>
            <button class="close-btn" (click)="closeAddAppointmentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body form-layout">
            <div class="form-row">
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" [value]="newAppointmentDate | date:'EEEE d MMMM yyyy'" disabled class="form-control disabled">
                </div>

                <div class="form-group">
                    <label>Heure <span class="required">*</span></label>
                    <input type="time" [(ngModel)]="newAppointmentTime" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label>Patient</label>
                <select [(ngModel)]="newAppointmentPatientName" class="form-control">
                    <option value="" disabled selected>Sélectionner un patient</option>
                    <option *ngFor="let p of mockPatientsList" [value]="p.name">{{ p.name }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>Services Médicaux (sélection multiple) (facultatif)</label>
                <select multiple [(ngModel)]="newAppointmentServices" class="form-control" style="height: 120px;">
                    <option *ngFor="let s of availableServices" [value]="s">{{ s }}</option>
                </select>
                <small style="color: #888; font-size: 11px;">Maintenez Ctrl (Windows) ou Cmd (Mac) pour sélectionner plusieurs services.</small>
            </div>
            
            <div class="form-group">
                 <label>Notes (facultatif)</label>
                 <textarea [(ngModel)]="newAppointmentNote" class="form-control" rows="3"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeAddAppointmentModal()">Annuler</button>
            <button class="btn-save" (click)="saveNewAppointment()" [disabled]="!newAppointmentTime">Enregistrer</button>
        </div>
    </div>
  </div>

  <!-- Context Menu for Events -->
  <div class="context-menu-dropdown" 
       *ngIf="showContextMenu" 
       [style.top.px]="contextMenuPosition.y" 
       [style.left.px]="contextMenuPosition.x"
       (click)="$event.stopPropagation()">
      <ul>
          <li (click)="editEvent(contextMenuEvent)">
              <i class="fas fa-edit"></i> Modifier
          </li>
          <li (click)="deleteEvent(contextMenuEvent)" class="delete">
              <i class="fas fa-trash-alt"></i> Supprimer
          </li>
      </ul>
  </div>

</main>
